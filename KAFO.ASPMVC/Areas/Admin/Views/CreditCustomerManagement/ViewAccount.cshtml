@model KAFO.ASPMVC.Areas.Admin.ViewModels.CreditCustomerAccountVM
@{
    ViewData["Title"] = "حساب عميل آجل";
    Layout = "_DefaultLayout";
    // For testing: add more transactions if less than 10
    // if (Model.Transactions.Count < 10)
    // {
    //     var extra = 10 - Model.Transactions.Count;
    //     for (int i = 0; i < extra; i++)
    //     {
    //         Model.Transactions.Add(new KAFO.ASPMVC.Areas.Admin.ViewModels.CreditCustomerTransactionVM {
    //             SellerName = $"بائع تجريبي {i+1}",
    //             Time = DateTime.Now.AddDays(-i),
    //             DepositMoney = (i % 2 == 0 ? 100 + i * 10 : -50 - i * 5)
    //         });
    //     }
    // }
    var transactionsJson = Newtonsoft.Json.JsonConvert.SerializeObject(Model.Transactions);
}
<link rel="stylesheet" href="~/css/credit-customers.css" />

<div class="credit-customer-bg py-4">
    <div class="row justify-content-center mb-4">
        <div class="col-lg-8 col-xl-7">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <a href="/Admin/Admin/Index" class="modern-back-btn">
                    <i class="fas fa-home me-2"></i> العودة للصفحة الرئيسية
                </a>
            </div>
            <div class="glass-card p-4 mb-4">
                <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-4">
                    <div class="d-flex flex-column align-items-center">
                        <span class="modern-badge mb-2" style="background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%); color: #fff;">
                            <i class="fas fa-wallet fa-lg me-2"></i> الرصيد
                        </span>
                        <div class="display-5 fw-bold mt-2">@Model.Balance.ToString("N2") <span class="egp-currency">ج.م</span></div>
                    </div>
                    <div class="d-flex flex-column align-items-center">
                        <span class="modern-badge mb-2" style="background: linear-gradient(135deg, #ffc107 0%, #ffecb3 100%); color: #333;">
                            <i class="fas fa-credit-card fa-lg me-2"></i> الآجل
                        </span>
                        <div class="display-5 fw-bold mt-2">@Model.Credit.ToString("N2") <span class="egp-currency">ج.م</span></div>
                    </div>
                </div>
            </div>
            <div class="glass-card p-4 mb-4">
                <ul class="nav nav-tabs mb-3" id="customerTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">
                            <i class="fas fa-user-tag"></i> بيانات العميل
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab" aria-controls="transactions" aria-selected="false">
                            <i class="fas fa-list-alt"></i> سجل المعاملات
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="customerTabContent">
                    <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                        <div class="row g-3 align-items-start">
                            <div class="col-12">
                                <div class="customer-profile-card glass-card p-4 d-flex flex-column flex-md-row align-items-center gap-4 animate__animated animate__fadeIn">
                                    <div class="profile-avatar d-flex align-items-center justify-content-center mb-3 mb-md-0" style="width: 90px; height: 90px; border-radius: 50%; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); box-shadow: 0 2px 8px rgba(80,0,120,0.13);">
                                        <i class="fas fa-user-circle fa-4x text-white"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="customer-name mb-2" style="font-size: 1.5rem; font-weight: 700; color: #6a11cb; letter-spacing: 0.01em;">
                                            <i class="fas fa-user me-2"></i>@Model.Name
                                        </div>
                                        <div class="d-flex flex-wrap gap-3">
                                            <div class="info-label d-flex align-items-center mb-1">
                                                <i class="fas fa-phone-alt me-2"></i>
                                                <span>@Model.Phone</span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(Model.Email)) {
                                                <div class="info-label d-flex align-items-center mb-1">
                                                    <i class="fas fa-envelope me-2"></i>
                                                    <span>@Model.Email</span>
                                                </div>
                                            }
                                            <div class="info-label d-flex align-items-center mb-1">
                                                <i class="fas fa-venus-mars me-2"></i>
                                                <span>@Model.Gender</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="transactions" role="tabpanel" aria-labelledby="transactions-tab">
                        <div class="modern-table-container mt-4">
                            <div class="modern-header mb-3">
                                <i class="fas fa-list-alt fs-3"></i>
                                <h4>سجل المعاملات</h4>
                            </div>
                            <div class="table-responsive">
                                <table class="table credit-customers-table mb-0">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-user-tie"></i> اسم البائع</th>
                                            <th><i class="fas fa-clock"></i> الوقت</th>
                                            <th><i class="fas fa-money-bill-wave"></i> المبلغ المودع</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactions-table-body">
                                        <!-- JS will render rows here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-container credit-customers-table-card mt-3">
                                <div class="pagination-scroll">
                                    <nav>
                                        <ul class="pagination justify-content-center" id="transactions-pagination">
                                            <!-- JS will render pagination here -->
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    var allTransactions = @Html.Raw(transactionsJson);
    var recordsPerPage = 5;
    var currentPage = 1;
    var totalPages = Math.ceil(allTransactions.length / recordsPerPage);

    function renderTransactions(page) {
        try {
            Swal.fire({
                title: 'جاري التحميل...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            setTimeout(function() { // Simulate loading for effect
                currentPage = page;
                var start = (page - 1) * recordsPerPage;
                var end = start + recordsPerPage;
                var paged = allTransactions.slice(start, end);
                var tbody = '';
                paged.forEach(function(t) {
                    var amountClass = t.DepositMoney >= 0 ? 'positive' : 'negative';
                    tbody += `<tr>
                        <td><span class="badge badge-seller"><i class="fas fa-user-tie me-2"></i>${t.SellerName}</span></td>
                        <td><span class="badge badge-time"><i class="fas fa-clock me-2"></i>${formatDate(t.Time)}</span></td>
                        <td><span class="badge badge-amount ${amountClass}"><i class="fas fa-money-bill-wave me-2"></i>${parseFloat(t.DepositMoney).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} <span class="egp-currency">ج.م</span></span></td>
                    </tr>`;
                });
                $("#transactions-table-body").html(tbody);
                totalPages = Math.ceil(allTransactions.length / recordsPerPage);
                renderPagination();
                Swal.close();
            }, 400); // 400ms for smooth effect
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'حدث خطأ غير متوقع',
                text: err.message || 'يرجى المحاولة مرة أخرى.',
                confirmButtonColor: '#6a11cb',
                background: '#fff',
                color: '#222',
                showClass: { popup: 'animate__animated animate__fadeInDown' },
                hideClass: { popup: 'animate__animated animate__fadeOutUp' }
            });
        }
    }

    function renderPagination() {
        var pag = '';
        pag += `<li class="page-item ${currentPage == 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="if(currentPage>1) renderTransactions(currentPage-1); return false;"><i class="fas fa-chevron-right me-1"></i>السابق</a></li>`;
        for (var i = 1; i <= totalPages; i++) {
            pag += `<li class="page-item ${i == currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="renderTransactions(${i}); return false;">${i}</a></li>`;
        }
        pag += `<li class="page-item ${currentPage == totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="if(currentPage<totalPages) renderTransactions(currentPage+1); return false;">التالي<i class="fas fa-chevron-left me-1"></i></a></li>`;
        $("#transactions-pagination").html(pag);
    }

    function formatDate(dateStr) {
        var d = new Date(dateStr);
        var y = d.getFullYear();
        var m = (d.getMonth()+1).toString().padStart(2,'0');
        var day = d.getDate().toString().padStart(2,'0');
        var h = d.getHours().toString().padStart(2,'0');
        var min = d.getMinutes().toString().padStart(2,'0');
        return `${y}/${m}/${day} ${h}:${min}`;
    }

    Swal.fire({
        title: 'جاري التحميل...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });
    $(function() {
        try {
            renderTransactions(1);
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'حدث خطأ غير متوقع',
                text: err.message || 'يرجى المحاولة مرة أخرى.',
                confirmButtonColor: '#6a11cb',
                background: '#fff',
                color: '#222',
                showClass: { popup: 'animate__animated animate__fadeInDown' },
                hideClass: { popup: 'animate__animated animate__fadeOutUp' }
            });
        } finally {
            Swal.close();
        }
    });
</script> 