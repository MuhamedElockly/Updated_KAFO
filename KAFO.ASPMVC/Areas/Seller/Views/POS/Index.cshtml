@model Invoice
@{
    ViewData["Title"] = "نقطة البيع";
    Layout = "_Layout";
    var e = ViewData.ModelState.IsValid;
    Dictionary<int, string> invoiceTypesList = new();
    invoiceTypesList.Add(0, "فاتورة نقدي");
    invoiceTypesList.Add(1, "فاتورة اجل");
    invoiceTypesList.Add(3, "فاتورة مرتجع نقدي");
    invoiceTypesList.Add(4, "فاتورة مرتجع اجل");
    // SelectList selectListItems = new SelectList(invoiceTypes);
}
<link rel="stylesheet" href="~/css/POS.css" asp-append-version="true" />

<form asp-controller="Invoice" asp-action="Create" asp-route-dist="pos" method="post" id="invoiceForm">
    <div class="row id="main-flex">
        <!-- Products Section -->
        <div class="product-list col-lg-8 d-flex flex-column">
            <label asp-for="Type" class="form-label fw-bold">نوع الفاتورة</label>
            <div class="row">
                <!-- Invoice Type Selection -->
                <div class="mb-2 col-6">

                    <select asp-for="Type" class="form-select" id="InvoiceTypeSelect">
                        @foreach (var item in invoiceTypesList)
                        {
                            <option value="@item.Key">@item.Value</option>
                        }
                    </select>
                </div>
                <!-- Search Bar -->
                <div class="search-container  col-6">
                    <div class="position-relative">
                        <input type="text" class="form-control search-input" placeholder="البحث عن المنتجات..." id="searchInput">
                    </div>
                </div>
                <div id="customerSelect" style="display: none;" class="mb-2 col-12">
                    <span asp-validation-for="Type" class="mt-2 text-danger"></span>
                    <select asp-for="CustomerAccountId" class="mt-2 form-select col-12" id="customerSelectV">
                        <option value="">اختر العميل</option>
                        @if (ViewBag.Customers != null)
                        {
                            foreach (var customer in (List<KAFO.Domain.Users.CustomerAccount>) ViewBag.Customers)
                            {
                                <option value="@customer.Id">@customer.CustomerName</option>
                            }
                        }
                    </select>
                </div>

            </div>

            <!-- Category Pills -->
            <div class="category-pills">
                <div>
                    <button type="button" class="category-pill" onclick="filterProducts('all', this)">
                        <i class="fas fa-th-large me-1"></i>
                        الكل
                    </button>
                    @foreach (Category cat in ViewBag.Cats)
                    {
                        <button type="button" class="category-pill" onclick="filterProducts('@cat.Name', this)">
                            @cat.Name
                        </button>
                    }
                </div>
            </div>

            <!-- Products Grid -->
            <div class="products-grid">
                <h6 class="mb-3 fw-bold text-secondary">
                    <i class="fas fa-shopping-bag me-2"></i>
                    المنتجات
                </h6>
                <div class="products-scroll-wrapper flex-grow-1 overflow-auto">
                    <div class="row flex-nowrap flex-md-wrap" id="productsList">
                        @if (ViewBag.Products != null)
                        {
                            <div class="products-grid-container">
                                @foreach (var product in ViewBag.Products)
                                {
                                    <div class="product-grid-item" data-category="@product.Category.Name">
                                        <div class="product-card position-relative" data-product-id="@product.Id" onclick="addToCart(@product.Id, '@product.Name', @product.SellingPrice, '@product.ImageUrl')">
                                            <div class="ImgContainer">
                                                <img src="@product.ImageUrl" class="product-image" alt="@product.Name">
                                            </div>
                                            <div class="product-info">
                                                <h6 class="product-title">@product.Name</h6>
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div>
                                                        <span class="product-price">@product.SellingPrice.ToString("N2") ج.م</span>
                                                    </div>
                                                    <div>
                                                        <span class="product-price">متبقي @product.StockQuantity قطع</span>
                                                    </div>
                                                </div>
                                                <button type="button" class="add-to-cart-btn" onclick="event.stopPropagation(); addToCart(@product.Id, '@product.Name', @product.SellingPrice, '@product.ImageUrl')">
                                                    <i class="fas fa-cart-plus me-1"></i>
                                                    إضافة للسلة
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        <!-- Cart Section -->
        <div class="col-lg-4 h-100 d-flex flex-column">
            <span class="EmptyCart text-danger"></span>
            <!-- Barcode Scan Input (Desktop Only) -->
            <div class="barcode-scan-container d-none d-lg-block mb-3">
                <input type="text" id="barcodeScanInput" class="form-control barcode-scan-input" placeholder="امسح الباركود هنا..." autocomplete="off" autofocus onkeydown="if(event.key==='Enter'){ event.preventDefault(); if(this.value.trim()){ handleBarcodeScan(this.value); this.value=''; } this.focus(); }">
            </div>
            <!-- Barcode Scan Input (Mobile Only) -->
            <div class="barcode-scan-container d-block d-lg-none mb-3 mt-5">
                <input type="text" id="barcodeScanInputMobile" class="form-control barcode-scan-input " placeholder="امسح الباركود هنا..." autocomplete="off" onkeydown="if(event.key==='Enter'){ event.preventDefault(); if(this.value.trim()){ handleBarcodeScan(this.value); this.value=''; } this.focus(); }">
            </div>
            <div class="cart-container flex-grow-1 d-flex flex-column">
                <div class="cart-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>
                            سلة المشتريات
                        </h5>
                        <span class="badge bg-light text-dark" id="cartItemsCount">0</span>
                    </div>
                </div>
                <div class="cart-items flex-grow-1 overflow-auto" id="cartItems">
                    <div class="text-center text-muted py-5" id="emptyCartMessage">
                        <i class="fas fa-shopping-cart fa-3x mb-3 opacity-50"></i>
                        <p>سلة المشتريات فارغة</p>
                        <small>اختر المنتجات لإضافتها إلى السلة</small>
                    </div>
                </div>
                <!-- Hidden inputs for invoice items -->
                <div id="invoiceItemsInputs"></div>
                <div class="cart-summary mt-auto">
                    <div class="summary-row">
                        <span>المجموع الكلي:</span>
                        <span id="total">0.00 ج.م</span>
                    </div>
                    <input type="hidden" asp-for="TotalInvoice" id="totalInvoiceInput" />
                    <div class="action-buttons">
                        <button type="button" class="action-btn btn-cancel" onclick="clearCart()">
                            <i class="fas fa-times-circle"></i>
                            إلغاء
                        </button>
                        <button type="submit" class="action-btn btn-charge" id="processPaymentBtn">
                            <i class="fas fa-credit-card"></i>
                            دفع
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Custom Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: var(--border-radius); border: none; box-shadow: var(--box-shadow-lg);">
            <div class="modal-body text-center p-4">
                <div class="mb-3" id="alertIcon">
                    <i class="fas fa-exclamation-circle fa-4x text-warning"></i>
                </div>
                <h4 class="mb-3" id="alertTitle">تنبيه</h4>
                <p class="text-muted mb-4" id="alertMessage"></p>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="alertConfirmBtn">
                    <i class="fas fa-check me-2"></i>
                    موافق
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <partial name="_IndexScriptPartial" />
}
